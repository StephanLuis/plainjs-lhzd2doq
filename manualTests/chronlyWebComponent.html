<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <chronly-hms id="Bob"></chronly-hms>
    <chronly-hms id="Jane"></chronly-hms>
    <input type="date" id="BobsDate"></input>
    <p id="what">This is for testing HTMLelement prototype update</p>
    <script>
        class ChronlyHMSElement extends HTMLElement {
            constructor() {
                super();

                this.myElement = this.attachShadow({ mode: 'open' });

                this.checkBoot();






                /**
                 * this prevents non-numerics from being entered, should 
                 * be put into a method
                 */



                // run checkboot again (why??)
                // this.checkBoot()









                // old WC


            }  // end constructor


            /**
             * eventlistener that adds arrow key input of values (up/down) and place toggling (left/right) triggered by
             * the change event of the input 
             * @method
             * @see boot()
             */

            addArrowKeyInput() {


                console.log('1 this: ' + this);
                console.log('1 this.myElement: ' + this.myElement);
                console.log('1 this.myElement active: ' + this.myElement);

                var mE = this.myElement;

                // Left and Right arrow key toggle between HMSmS
                // this depends on data-attributes ex. data-tp="1" in HTML

                this.myElement.querySelector("div.timeCase")
                    .addEventListener('keydown', function (event) {

                        var et = event.target;
                        var tp_active = mE.activeElement.dataset.tp;

                        switch (true) {

                            case event.key == "ArrowLeft":

                                if (tp_active >= 2) {
                                    tp_active--;
                                }

                                et.parentElement.querySelector("[data-tp='" + tp_active + "']").focus();
                                setTimeout(function () { et.parentElement.querySelector("[data-tp='" + tp_active + "']").select(); }, 5);

                                break;

                            case event.key == "ArrowRight":
                                // tp_active = this.myElement.shadowRoot.activeElement.dataset.tp;

                                if (tp_active <= 3) {
                                    tp_active++;
                                }

                                et.parentElement.querySelector("[data-tp='" + tp_active + "']").focus();
                                setTimeout(function () { et.parentElement.querySelector("[data-tp='" + tp_active + "']").select(); }, 5);

                                break;

                            // these keep the input selected
                            case event.key == "ArrowUp":
                                
                                setTimeout(function () { mE.activeElement.select(); }, 5);

                                break;

                            case event.key == "ArrowDown":

                                setTimeout(function () { mE.activeElement.select(); }, 5);

                                break;

                            // this is good for testing, to determine whether a key press is detected
                            case /^([0-9]?)$/.test(event.key):

                                break;

                        }
                    });
            }

            /**
             * used by boot() to update inputs marked with data-univHMS
             * @method
             * @see boot()
             */

            addHTML() {

                var spanIn = document.createElement("div");

                spanIn.classList.add('timeCase');

                var template = document.createElement('template');

                template.innerHTML = `
                    <input type="number" class="sH D2 ts_digit" name="startHours" data-tp="1" min="-1" max="100" value="00" >
                    <span class="bds-h">:</span>
                    <input type="number" class="sM D2 ts_digit" name="startMinutes" data-tp="2" min="-1" max="60" value="00">
                    <span class="bds-m">:</span>
                    <input type="number" class="sS D2 ts_digit" name="startSeconds" data-tp="3" min="-1" max="60" value="00">
                    <span class="bds-s">.</span>
                    <input type="number" class="sMS D3 ts_digit" name="startMilliSecs" data-tp="4" min="-10" max="1010" step="10" value="000">
                    <div id="svgContainer">
                        <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true"
                        focusable="false" data-prefix="fal" data-icon="stopwatch" class="svg-inline--fa fa-stopwatch fa-w-14"
                        role="img" viewBox="0 0 448 512">
                        <path xmlns="http://www.w3.org/2000/svg" fill="currentColor" d="M393.9 184l22.6-22.6c4.7-4.7 4.7-12.3 0-17l-17-17c-4.7-4.7-12.3-4.7-17 0l-20.7 20.7c-31.1-27.5-70.4-45.9-113.8-50.8V48h28c6.6 0 12-5.4 12-12V12c0-6.6-5.4-12-12-12H172c-6.6 0-12 5.4-12 12v24c0 6.6 5.4 12 12 12h28v49.4C96.4 109.3 16 197.2 16 304c0 114.9 93.1 208 208 208s208-93.1 208-208c0-44.7-14.1-86.1-38.1-120zM224 464c-88.4 0-160-71.6-160-160s71.6-160 160-160 160 71.6 160 160-71.6 160-160 160zm12-112h-24c-6.6 0-12-5.4-12-12V204c0-6.6 5.4-12 12-12h24c6.6 0 12 5.4 12 12v136c0 6.6-5.4 12-12 12z"/>
                        </svg>
                    </div>
                                    `

                spanIn.appendChild(template.content);


                const chronlyCssLink = document.createElement('link');
                let link = document.createElement('link');
                chronlyCssLink.setAttribute('rel', 'stylesheet');
                chronlyCssLink.setAttribute('href', 'chronlyWebComponent.css');




                this.myElement.appendChild(spanIn);

                this.myElement.appendChild(chronlyCssLink);

            }


            /**
             * eventlistener that adds number looping for up and down keys triggered by
             * the change event of the input 
             * @method
             * @see boot()
             */

            addNumberLooping() {

                // Numeric Value looping (eventually this can be 'parameterised' refactored)
                // ex. 99 uparrow to 0 hours, 59 uparrow to 0 minutes and seconds, 990 uparrow to 010, downarrow 000 milliseconds

                this.myElement.querySelectorAll("input.sH").forEach(i =>
                    i.addEventListener('change', function (event) {

                        if (i.value == 100) {
                            i.value = '00';
                        }
                        if (i.value == -1) {
                            i.value = 99;
                        }

                    }));


                this.myElement.querySelectorAll("input.sM").forEach(i =>
                    i.addEventListener('change', function (event) {

                        if (i.value == 60) {
                            i.value = '00';
                        }
                        if (i.value == -1) {
                            i.value = 59;
                        }

                    }));


                this.myElement.querySelectorAll("input.sS").forEach(i =>
                    i.addEventListener('change', function (event) {

                        if (i.value == 60) {
                            i.value = '00';
                        }

                        if (i.value == -1) {
                            i.value = 59;
                        }

                    }));


                this.myElement.querySelectorAll("input.sMS").forEach(i =>
                    i.addEventListener('change', function (event) {

                        if (i.value == 1000) {
                            i.value = "010";
                        }

                        if (i.value == -10) {
                            i.value = 990;
                        }

                        if (i.value == 0) {
                        }

                    }));
            }


            /**
             * each time Chronly is newed up, the constructor uses checkBoot() to
             * 1) check for an existing window.ChronlyFlag if there is one 
             * 2) clear events a) named events, b) remove 
             * 3) add events
             * @method 
             */

            checkBoot() {

                if (window.ChronlyFlag) {
                    this.reboot();
                }
                else {
                    this.boot();
                }
            }



            /**
            * used by checkBoot() and externally exposed for user
            * @method
            * 
            */

            boot() {

                this.addHTML();
                this.blockNonNumberInput();

                // // set up event listeners
                this.add0s();
                this.addNumberLooping();
                this.addArrowKeyInput();
                // this.addNumericInput();
                this.addClicksToActivate();
                // this.nonNumericBugInHTML();
                this.updatePrototype();


                /**
                 * window.ChronlyFlag declared here
                 * @global  
                 */
                window.ChronlyFlag = true;
            }


            /**
             * eventlistener that adds 0s to preface numbers less than 10 triggered by
             * the change event of the input 
             * @method
             * @see boot()
             */

            add0s() {

                // input for hours, minutes, seconds
                this.myElement.querySelectorAll('input').forEach(i => i.addEventListener('change', function () {
                    if (!isNaN(this.value) && this.value.length === 1) {
                        this.value = '0' + this.value;
                    }
                }));

                // milliseconds
                this.myElement.querySelectorAll("input.sMS").forEach(i => i.addEventListener('change', function () {

                    if (!isNaN(this.value) && this.value.length === 2) {
                        this.value = '0' + this.value;
                    }

                }));

            }





            /**
             * used by checkBoot() and externally exposed for user
             * @method
             * @see boot()
             */

            reboot() {

                // for each input in the timeCase replace it with (the original/ an) input

                var elements = document.querySelectorAll('.timeCase');

                elements.forEach(element => {

                    var replaceElement = document.createElement('input');

                    [...element.attributes].forEach(attr => { replaceElement.setAttribute(attr.nodeName, attr.nodeValue) });

                    element.parentElement.insertBefore(replaceElement, element);

                    element.remove();

                    // removes eventlisters 
                    element = ''

                });

                this.boot();

            }


            // this needs to be updated or removed, test

            blockNonNumberInput() {

                document.querySelectorAll(".timeCase input").forEach(item =>

                    item.addEventListener('keypress', function (e) {

                        e = e || window.event;
                        var charCode = (typeof e.which == "undefined") ? e.keyCode : e.which;
                        var charStr = String.fromCharCode(charCode);

                        if (!charStr.match(/^[0-9]+$/))
                            e.preventDefault();

                    }));
            }


            // second idea is to update prototype of ChronlyInputElement (class)

            updatePrototype() {

                ChronlyHMSElement.prototype.__defineGetter__('value', function () {

                    if (this.myElement.querySelector('input[name="startHours"]') !== null) {

                        return this.myElement.querySelector('input[name="startHours"]').value +
                            ':' + this.myElement.querySelector('input[name="startMinutes"]').value +
                            ':' + this.myElement.querySelector('input[name="startSeconds"]').value +
                            '.' + this.myElement.querySelector('input[name="startMilliSecs"]').value;

                    }
                    else {

                        return null;

                    }
                });



                ChronlyHMSElement.prototype.__defineSetter__('value', function (timeString) {

                    // will need warning about timeString format (like input type='time')

                    if (/(^[0-9][0-9]):([0-5][0-9]):([0-5][0-9])\.([0-9][0-9][0-9]$)/.exec(timeString)) {

                        // split val

                        var timeArray = timeString.split(/[.:]+/);

                        this.myElement.querySelector('input[name="startHours"]').value = timeArray[0];
                        this.myElement.querySelector('input[name="startMinutes"]').value = timeArray[1];
                        this.myElement.querySelector('input[name="startSeconds"]').value = timeArray[2];
                        this.myElement.querySelector('input[name="startMilliSecs"]').value = timeArray[3];

                    }
                    else {

                        console.warn(`The specified value ${timeString} does not conform to the required format.  The format is "HH:mm:ss.SSS" where HH is 00-99, mm is 00-59, ss is 00-59, and SSS is 000-999.`);

                    }

                });
            }

            /**
             * eventlistener that adds click to activate input of values by the keyboard triggered by
             * the click event of the input 
             * @method
             * @see boot()
             */

            addClicksToActivate() {

                this.myElement.querySelectorAll('input').forEach(i => i.addEventListener("click", function () { this.select(); }))
            }

        }  // end class


        // page script (try making this auto instantiate in module like PM does)

        customElements.define('chronly-hms', ChronlyHMSElement);

    </script>
</body>

</html>